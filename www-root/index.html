<!DOCTYPE html>
<html>
<head>

    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-beta/css/bootstrap.min.css" integrity="sha384-/Y6pD6FV/Vv2HJnA6t+vslU6fwYXjCFtcEpHbNJ0lyAFsXTsjBbfaDjzALeQsN6M" crossorigin="anonymous">
    <script
      src="https://code.jquery.com/jquery-3.2.1.min.js"
      integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4="
      crossorigin="anonymous"></script> 
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.11.0/umd/popper.min.js" integrity="sha384-b/U6ypiBEHpOf/4+1nzFpr53nxSS+GLCkfwBdFNTxtclqqenISfwAzpKaMNFNmj4" crossorigin="anonymous"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-beta/js/bootstrap.min.js" integrity="sha384-h0AbiXch4ZDo7tp9hKZ4TsHbi047NrKGLO3SEJAg45jXxnGIfYzk4Si90RDIqNm1" crossorigin="anonymous"></script>

</head>
<body>

<div>

    <div id="flm-error" style="display:none" class="flm-alert alert alert-danger" role="alert">
    </div>    

    <div id="flm-success" style="display:none" class="flm-alert alert alert-success" role="alert">
        Success
    </div>    

    <form>
      <div class="form-group">
        <label for="file">Choose file</label>
        <input type="file" class="form-control-file" id="file">
      </div>
      <button type="submit" id="submit" name="submit" class="btn btn-primary">Upload</button>
    </form>

    <table class="table table-striped">
      <thead>
        <tr>
          <th>#</th>
          <th>File name</th>
          <th>Created at</th>
          <th>Action</th>
        </tr>
      </thead>
      <tbody id="flm-tbody">
      </tbody>
    </table>
</div>

<script type="text/javascript">
    window.FLM = {};

    FLM.api_url = "http://46.101.174.93:5556/api";

    loadFilesData();

    function loadFilesData() {
        $.ajax({
            url: FLM.api_url,
            method: 'GET',
            data: {
                method: 'get_files_list'
            },
            success: function(res) {
                console.log(res);
                if(typeof res.status !== 'undefined') {
                    if(res.status.status == "ok") {
                        var html = '';

                        for(var i = 0; i < res.result.length; i++) {
                            html += '<tr>';
                            html += '<td scope="row">' + res.result[i].id + '</td>';
                            html += '<td>' + res.result[i].name + '</td>';
                            html += '<td>' + res.result[i].inserted_at + '</td>';
                            html += '<td><button type="button" data-file_id="'+res.result[i].id+'" class="btn btn-danger flm-delete-file">Delete</button></td>';
                            html += '</tr>';
                        }

                        $("#flm-tbody").html(html);

                    } else {
                        $(".flm-alert").hide();
                        $("#flm-error").text(res.status.msg).show();
                    }
                }
            },
            error: function(xhr, textStatus, errorThrown) {
                
            }
        });
    }

    $(document).on("click", ".flm-delete-file", function(e) {
        var file_id = $(this).data('file_id');

        $.ajax({
            url: FLM.api_url,
            method: 'POST',
            data: {
                method: 'delete_file',
                file_id: file_id,
            },
            success: function(res) {
                console.log(res);
                if(typeof res.status !== 'undefined') {
                    if(res.status.status == "ok") {
                        $(".flm-alert").hide();
                        $("#flm-success").text("File is deleted").show();
                        loadFilesData();
                    } else {
                        $(".flm-alert").hide();
                        $("#flm-error").text(res.status.msg).show();
                    }
                }
            },
            error: function(xhr, textStatus, errorThrown) {
                console.log("Error", textStatus, errorThrown);
            }
        });
    });

    $("#submit").click(function(e) {
        e.preventDefault();
        var data = new FormData();

        data.append('method', 'upload_file');
        data.append('file', $("#file").prop('files')[0]);

        console.log("Dataz", data);

        $.ajax({
            // Your server script to process the upload
            url: FLM.api_url,
            type: 'POST',

            // Form data
            data: data,

            // Tell jQuery not to process data or worry about content-type
            // You *must* include these options!
            cache: false,
            contentType: false,
            processData: false,
            success: function(res) {
                console.log("Success ", res);
                if(typeof res.status !== 'undefined') {
                    if(res.status.status == "ok") {
                        $(".flm-alert").hide();
                        $("#flm-success").text("Upload successful").show();
                        loadFilesData();
                    } else {
                        $(".flm-alert").hide();
                        $("#flm-error").text(res.status.msg).show();
                    }
                }
            },
            error: function(xhr, textStatus, errorThrown) {
                console.log("Err",textStatus, errorThrown);
            },
            // Custom XMLHttpRequest
        });
    });
</script>

</body>
</html>
